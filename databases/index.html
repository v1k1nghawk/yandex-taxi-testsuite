
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Database support &#8212; yandex-taxi-testsuite 0.1.5.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments_pytest.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Other plugins" href="../other_plugins/" />
    <link rel="prev" title="Testpoint" href="../testpoint/" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="database-support">
<h1>Database support<a class="headerlink" href="#database-support" title="Permalink to this headline">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#common-database-marks" id="toc-entry-1">Common database marks</a></p>
<ul>
<li><p><a class="reference internal" href="#pytest-mark-nofilldb" id="toc-entry-2">pytest.mark.nofilldb</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#mongo" id="toc-entry-3">Mongo</a></p>
<ul>
<li><p><a class="reference internal" href="#fixtures" id="toc-entry-4">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#marks" id="toc-entry-5">Marks</a></p></li>
<li><p><a class="reference internal" href="#classes" id="toc-entry-6">Classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#postgresql" id="toc-entry-7">PostgreSQL</a></p>
<ul>
<li><p><a class="reference internal" href="#customize-port" id="toc-entry-8">Customize port</a></p></li>
<li><p><a class="reference internal" href="#use-external-instance" id="toc-entry-9">Use external instance</a></p></li>
<li><p><a class="reference internal" href="#reuse-database-between-simultaneous-sessions" id="toc-entry-10">Reuse database between simultaneous sessions</a></p></li>
<li><p><a class="reference internal" href="#example-integration" id="toc-entry-11">Example integration</a></p></li>
<li><p><a class="reference internal" href="#database-access-example" id="toc-entry-12">Database access example</a></p></li>
<li><p><a class="reference internal" href="#functions" id="toc-entry-13">Functions</a></p></li>
<li><p><a class="reference internal" href="#fixtures-1" id="toc-entry-14">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#marks-1" id="toc-entry-15">Marks</a></p></li>
<li><p><a class="reference internal" href="#classes-1" id="toc-entry-16">Classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#mysql" id="toc-entry-17">MySQL</a></p>
<ul>
<li><p><a class="reference internal" href="#customize-port-1" id="toc-entry-18">Customize port</a></p></li>
<li><p><a class="reference internal" href="#use-external-instance-1" id="toc-entry-19">Use external instance</a></p></li>
<li><p><a class="reference internal" href="#example-integration-1" id="toc-entry-20">Example integration</a></p></li>
<li><p><a class="reference internal" href="#database-access-example-1" id="toc-entry-21">Database access example</a></p></li>
<li><p><a class="reference internal" href="#functions-1" id="toc-entry-22">Functions</a></p></li>
<li><p><a class="reference internal" href="#fixtures-2" id="toc-entry-23">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#marks-2" id="toc-entry-24">Marks</a></p></li>
<li><p><a class="reference internal" href="#classes-2" id="toc-entry-25">Classes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#redis" id="toc-entry-26">Redis</a></p></li>
<li><p><a class="reference internal" href="#clickhouse" id="toc-entry-27">ClickHouse</a></p>
<ul>
<li><p><a class="reference internal" href="#clickhouse-installation" id="toc-entry-28">ClickHouse installation</a></p></li>
<li><p><a class="reference internal" href="#customize-ports" id="toc-entry-29">Customize ports</a></p></li>
<li><p><a class="reference internal" href="#use-external-instance-2" id="toc-entry-30">Use external instance</a></p></li>
<li><p><a class="reference internal" href="#example-integration-2" id="toc-entry-31">Example integration</a></p></li>
<li><p><a class="reference internal" href="#database-access-example-2" id="toc-entry-32">Database access example</a></p></li>
<li><p><a class="reference internal" href="#functions-2" id="toc-entry-33">Functions</a></p></li>
<li><p><a class="reference internal" href="#fixtures-3" id="toc-entry-34">Fixtures</a></p></li>
<li><p><a class="reference internal" href="#marks-3" id="toc-entry-35">Marks</a></p></li>
<li><p><a class="reference internal" href="#classes-3" id="toc-entry-36">Classes</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>Database plugins can start and stop database process.
You can configure it to use existing database.</p>
<p>Testsuite clears database and applies data fixtures before each test ensure
database in known state.</p>
<p>Data fixtures are loaded via staatic files, see <a class="reference internal" href="../staticfiles/#staticfiles"><span class="std std-ref">Working with static files</span></a>.</p>
<section id="common-database-marks">
<h2><a class="toc-backref" href="#toc-entry-1" role="doc-backlink">Common database marks</a><a class="headerlink" href="#common-database-marks" title="Permalink to this headline">¶</a></h2>
<section id="pytest-mark-nofilldb">
<h3><a class="toc-backref" href="#toc-entry-2" role="doc-backlink">pytest.mark.nofilldb</a><a class="headerlink" href="#pytest-mark-nofilldb" title="Permalink to this headline">¶</a></h3>
<p>Disables database loading.</p>
<dl class="function">
<dt id="pytest.mark.nofilldb">
<code class="descclassname">pytest.mark.</code><code class="descname">nofilldb</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pytest.mark.nofilldb" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</section>
</section>
<section id="mongo">
<h2><a class="toc-backref" href="#toc-entry-3" role="doc-backlink">Mongo</a><a class="headerlink" href="#mongo" title="Permalink to this headline">¶</a></h2>
<p>In ordrer to enable mongo support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.database.mongo.pytest_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure mongodb collections.</p>
<p>By default testsuite starts mongodb sharded cluster. In this case <a class="reference external" href="https://www.mongodb.com/">mongodb</a>
installation is required.</p>
<p>Testsuite may start mongodb with custom ports, if following environment
variables are specified:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_MONGO_CONFIG_SERVER_PORT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_MONGOS_PORT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_MONGO_SHARD_PORT</span></code></p></li>
</ul>
<p>You can force it to use your own mongo installation with command-line option
<code class="docutils literal notranslate"><span class="pre">--mongo=mongodb://host:port/</span></code>.</p>
<p>Mongodb plugins re-fills the whole database with data on each test.
It looks for data fixture static files using <code class="docutils literal notranslate"><span class="pre">db_collection_name.json</span></code>
pattern. If no file is found collection is empty.</p>
<p>Currently mongo plugin uses synchronous <a class="reference external" href="https://api.mongodb.com/python/current/">pymongo</a> driver.</p>
<p>Example integration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytest_plugins</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;testsuite.pytest_plugin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;testsuite.databases.mongo.pytest_plugin&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">MONGO_COLLECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;example_collection&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;settings&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="s1">&#39;example_collection&#39;</span><span class="p">,</span>
            <span class="s1">&#39;connection&#39;</span><span class="p">:</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span>
            <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;example_db&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;indexes&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mongodb_settings</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MONGO_COLLECTIONS</span>
</pre></div>
</div>
<section id="fixtures">
<h3><a class="toc-backref" href="#toc-entry-4" role="doc-backlink">Fixtures</a><a class="headerlink" href="#fixtures" title="Permalink to this headline">¶</a></h3>
<section id="mongodb-1">
<h4>mongodb<a class="headerlink" href="#mongodb-1" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.mongo.pytest_plugin.mongodb">
<code class="descclassname">testsuite.databases.mongo.pytest_plugin.</code><code class="descname">mongodb</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mongo/pytest_plugin/#mongodb"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.mongodb" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns <code class="xref py py-class docutils literal notranslate"><span class="pre">CollectionWrapper</span></code> instance. Collection can be accessed
by name, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">mongodb</span><span class="p">):</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">collection_name</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">})</span>
    <span class="k">assert</span> <span class="n">doc</span> <span class="o">==</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">pymongo.collection.Collection</span></code> instance is returned.</p>
</dd></dl>

</section>
<section id="mongo-connection-info">
<h4>mongo_connection_info<a class="headerlink" href="#mongo-connection-info" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.mongo.pytest_plugin.mongo_connection_info">
<code class="descclassname">testsuite.databases.mongo.pytest_plugin.</code><code class="descname">mongo_connection_info</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mongo/pytest_plugin/#mongo_connection_info"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.mongo_connection_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns an instance of class
<a class="reference internal" href="#testsuite.databases.mongo.connection.ConnectionInfo" title="testsuite.databases.mongo.connection.ConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.mongo.connection.ConnectionInfo</span></code></a></p>
</dd></dl>

</section>
<section id="mongo-host">
<h4>mongo_host<a class="headerlink" href="#mongo-host" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.mongo.pytest_plugin.mongo_host">
<code class="descclassname">testsuite.databases.mongo.pytest_plugin.</code><code class="descname">mongo_host</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mongo/pytest_plugin/#mongo_host"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.mongo_host" title="Permalink to this definition">¶</a></dt>
<dd><p>Deprecated, use <code class="docutils literal notranslate"><span class="pre">mongo_connection_info</span></code> instead
returns: string with mongo connection uri</p>
<p>This fixture is obsolete. Use <code class="docutils literal notranslate"><span class="pre">mongo_connection_info</span></code> fixture instead.</p>
<p>Returns mongodb connection string, e.g.:
<code class="docutils literal notranslate"><span class="pre">mongodb://localhost:27119/?retryWrites=false</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">retryWrites</span></code> parameter can be changed through <code class="docutils literal notranslate"><span class="pre">pytest.ini</span></code> via
<code class="docutils literal notranslate"><span class="pre">mongo-retry-writes</span></code> boolean setting. Default value is <code class="docutils literal notranslate"><span class="pre">false</span></code> which is
required since mongodb version 4.2 and pymongo version 3.9.</p>
</dd></dl>

</section>
</section>
<section id="marks">
<h3><a class="toc-backref" href="#toc-entry-5" role="doc-backlink">Marks</a><a class="headerlink" href="#marks" title="Permalink to this headline">¶</a></h3>
<section id="pytest-mark-filldb">
<h4>pytest.mark.filldb<a class="headerlink" href="#pytest-mark-filldb" title="Permalink to this headline">¶</a></h4>
<p>Specify custom per-test collection data file prefix.</p>
<dl class="function">
<dt id="testsuite.databases.mongo.pytest_plugin.pytest.mark.filldb">
<code class="descclassname">pytest.mark.</code><code class="descname">filldb</code><span class="sig-paren">(</span><em>**suffixes</em><span class="sig-paren">)</span><a class="headerlink" href="#testsuite.databases.mongo.pytest_plugin.pytest.mark.filldb" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>suffixes</strong> – collection suffixes map, e.g.
<code class="docutils literal notranslate"><span class="pre">{'collection':</span> <span class="pre">'suffix',</span> <span class="pre">...}</span></code></p>
</dd>
</dl>
</dd></dl>

<p>I
In the following example plugin will look for filename
<code class="docutils literal notranslate"><span class="pre">db_collection_name_foo.json</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">filldb</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
</pre></div>
</div>
</section>
</section>
<section id="classes">
<h3><a class="toc-backref" href="#toc-entry-6" role="doc-backlink">Classes</a><a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="testsuite.databases.mongo.connection.ConnectionInfo">
<em class="property">class </em><code class="descclassname">testsuite.databases.mongo.connection.</code><code class="descname">ConnectionInfo</code><a class="reference internal" href="../_modules/testsuite/databases/mongo/connection/#ConnectionInfo"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.mongo.connection.ConnectionInfo" title="Permalink to this definition">¶</a></dt>
<dd><p>Mongodb connection uri parameters</p>
<dl class="method">
<dt id="testsuite.databases.mongo.connection.ConnectionInfo.get_uri">
<code class="descname">get_uri</code><span class="sig-paren">(</span><em>dbname: Optional[str</em>, <em>None] = None</em>, <em>retry_writes: Optional[bool</em>, <em>None] = None</em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../_modules/testsuite/databases/mongo/connection/#ConnectionInfo.get_uri"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.mongo.connection.ConnectionInfo.get_uri" title="Permalink to this definition">¶</a></dt>
<dd><p>Get mongodb connection uri</p>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="postgresql">
<h2><a class="toc-backref" href="#toc-entry-7" role="doc-backlink">PostgreSQL</a><a class="headerlink" href="#postgresql" title="Permalink to this headline">¶</a></h2>
<p>In order to enable postgres support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.database.pgsql_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure postgresql schemas location.</p>
<p>By default testsuite starts <a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a> service. In this case
PostgreSQL installation is required.</p>
<p>Currently pgsql plugin uses synchronous <a class="reference external" href="https://pypi.org/project/psycopg2/">psycopg2</a> driver.</p>
<p>Pgsql plugin creates database schema once. And then populates database
with data fixtures on each test. It looks for database fixtures by the
following names:</p>
<ul class="simple">
<li><p>file <code class="docutils literal notranslate"><span class="pre">pg_DBNAME.sql</span></code></p></li>
<li><p>directory <code class="docutils literal notranslate"><span class="pre">pg_DBNAME/</span></code></p></li>
</ul>
<section id="customize-port">
<h3><a class="toc-backref" href="#toc-entry-8" role="doc-backlink">Customize port</a><a class="headerlink" href="#customize-port" title="Permalink to this headline">¶</a></h3>
<p>Testsuite may start postgres with custom port, if <code class="docutils literal notranslate"><span class="pre">TESTSUITE_POSTGRESQL_PORT</span></code>
environment variable is specified</p>
</section>
<section id="use-external-instance">
<h3><a class="toc-backref" href="#toc-entry-9" role="doc-backlink">Use external instance</a><a class="headerlink" href="#use-external-instance" title="Permalink to this headline">¶</a></h3>
<p>You can force it to use your own postgres installation with command-line option
<code class="docutils literal notranslate"><span class="pre">--postgresql=postgresql://db-postgresql/</span></code>.</p>
</section>
<section id="reuse-database-between-simultaneous-sessions">
<h3><a class="toc-backref" href="#toc-entry-10" role="doc-backlink">Reuse database between simultaneous sessions</a><a class="headerlink" href="#reuse-database-between-simultaneous-sessions" title="Permalink to this headline">¶</a></h3>
<p>In general, testsuite does not support running simultaneous sessions, except
when testsuite is started with <code class="docutils literal notranslate"><span class="pre">--postgresql-keep-existing-db</span></code> or
<code class="docutils literal notranslate"><span class="pre">--service-runner-mode</span></code> flag.</p>
<p>In service runner mode testsuite starts the service and waits indefinitely
so that developer can attach to running service with debugger.</p>
<p>If one session in service runner mode creates database and applies schemas,
then the next one will skip applying schemas on initialization, unless schemas
were modified since then.</p>
</section>
<section id="example-integration">
<h3><a class="toc-backref" href="#toc-entry-11" role="doc-backlink">Example integration</a><a class="headerlink" href="#example-integration" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">testsuite.databases.pgsql</span> <span class="kn">import</span> <span class="n">discover</span>

<span class="n">pytest_plugins</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;testsuite.pytest_plugin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;testsuite.databases.pgsql.pytest_plugin&#39;</span><span class="p">,</span>
<span class="p">]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pgsql_local</span><span class="p">(</span><span class="n">pgsql_local_create</span><span class="p">):</span>
    <span class="n">tests_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">sqldata_path</span> <span class="o">=</span> <span class="n">tests_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;../schemas/postgresql&#39;</span><span class="p">)</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">(</span><span class="s1">&#39;service_name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">sqldata_path</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pgsql_local_create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
</section>
<section id="database-access-example">
<h3><a class="toc-backref" href="#toc-entry-12" role="doc-backlink">Database access example</a><a class="headerlink" href="#database-access-example" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_read_from_database</span><span class="p">(</span><span class="n">pgsql</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">pgsql</span><span class="p">[</span><span class="s1">&#39;chat_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT username, text FROM messages WHERE id = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],),</span>
    <span class="p">)</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">record</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="functions">
<h3><a class="toc-backref" href="#toc-entry-13" role="doc-backlink">Functions</a><a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h3>
<section id="find-schemas">
<h4>find_schemas<a class="headerlink" href="#find-schemas" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.pgsql.discover.find_schemas">
<code class="descclassname">testsuite.databases.pgsql.discover.</code><code class="descname">find_schemas</code><span class="sig-paren">(</span><em>service_name: Optional[str, None], schema_dirs: List[pathlib.Path]</em><span class="sig-paren">)</span> &#x2192; Dict[str, testsuite.databases.pgsql.discover.PgShardedDatabase]<a class="reference internal" href="../_modules/testsuite/databases/pgsql/discover/#find_schemas"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.discover.find_schemas" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Read database schemas from directories <code class="docutils literal notranslate"><span class="pre">schema_dirs</span></code>. ::</dt><dd><dl class="simple">
<dt><a href="#system-message-1"><span class="problematic" id="problematic-1">|</span></a>- schema_path/</dt><dd><p><a href="#system-message-2"><span class="problematic" id="problematic-2">|</span></a>- database1.sql
<a href="#system-message-3"><span class="problematic" id="problematic-3">|</span></a>- database2.sql</p>
</dd>
</dl>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>service_name</strong> – service name used as prefix for database name if not
empty, e.g. “servicename_dbname”.</p></li>
<li><p><strong>schema_dirs</strong> – list of pathes to scan for schemas</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Dict[str,</span> <span class="pre">PgShardedDatabase]</span></code> where key is
database name as stored in <code class="xref py py-attr docutils literal notranslate"><span class="pre">PgShard.dbname</span></code></p>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="fixtures-1">
<h3><a class="toc-backref" href="#toc-entry-14" role="doc-backlink">Fixtures</a><a class="headerlink" href="#fixtures-1" title="Permalink to this headline">¶</a></h3>
<section id="pgsql">
<h4>pgsql<a class="headerlink" href="#pgsql" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.pgsql.pytest_plugin.pgsql">
<code class="descclassname">testsuite.databases.pgsql.pytest_plugin.</code><code class="descname">pgsql</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns str to
<a class="reference internal" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper" title="testsuite.databases.pgsql.control.PgDatabaseWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.pgsql.control.PgDatabaseWrapper</span></code></a> dictionary</p>
<p>Example usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_pg</span><span class="p">(</span><span class="n">pgsql</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">pgsql</span><span class="p">[</span><span class="s1">&#39;example_db&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT ... FROM ...WHERE ...&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">cusror</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="pgsql-cleanup-exclude-tables">
<h4>pgsql_cleanup_exclude_tables<a class="headerlink" href="#pgsql-cleanup-exclude-tables" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.pgsql.pytest_plugin.pgsql_cleanup_exclude_tables">
<code class="descclassname">testsuite.databases.pgsql.pytest_plugin.</code><code class="descname">pgsql_cleanup_exclude_tables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql_cleanup_exclude_tables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql_cleanup_exclude_tables" title="Permalink to this definition">¶</a></dt>
<dd><p>Redefine this fixture when you don’t need to clean some tables.
For example postgis create table with spatial reference systems. To use postgis you need to
add this fixture with spatial_ref_sys table.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pgsql_cleanup_exclude_tables</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s1">&#39;public.spatial_ref_sys&#39;</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="pgsql-local">
<h4>pgsql_local<a class="headerlink" href="#pgsql-local" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.pgsql.pytest_plugin.pgsql_local">
<code class="descclassname">testsuite.databases.pgsql.pytest_plugin.</code><code class="descname">pgsql_local</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql_local"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql_local" title="Permalink to this definition">¶</a></dt>
<dd><p>Configures local pgsql instance.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig" title="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">ServiceLocalConfig</span></code></a> instance.</p>
</dd>
</dl>
<p>In order to use pgsql fixture you have to override pgsql_local()
in your local conftest.py file, example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pgsql_local</span><span class="p">(</span><span class="n">pgsql_local_create</span><span class="p">):</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">(</span>
        <span class="s1">&#39;service_name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">PG_SCHEMAS_PATH</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pgsql_local_create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
<p>Sometimes it is desirable to have tests-only database, maybe used in one
particular test or tests group. This can be achieved by by overriding
<code class="docutils literal notranslate"><span class="pre">pgsql_local</span></code> fixture in your test file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">pgsql_local</span><span class="p">(</span><span class="n">pgsql_local_create</span><span class="p">):</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">(</span>
        <span class="s1">&#39;testsuite&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;custom/pgsql/schema/path&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">pgsql_local_create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pgsql_local</span></code> provides access to PostgreSQL connection parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_custom_connection_string</span><span class="p">(</span><span class="n">pgsql_local</span><span class="p">):</span>
    <span class="n">conninfo</span> <span class="o">=</span> <span class="n">pgsql_local</span><span class="p">[</span><span class="s1">&#39;database_name&#39;</span><span class="p">]</span>
    <span class="n">custom_dsn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">conninfo</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="s1">&#39;-c opt=val&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_dsn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">custom_dsn</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="pgsql-local-create">
<h4>pgsql_local_create<a class="headerlink" href="#pgsql-local-create" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.pgsql.pytest_plugin.pgsql_local_create">
<code class="descclassname">testsuite.databases.pgsql.pytest_plugin.</code><code class="descname">pgsql_local_create</code><span class="sig-paren">(</span><em>databases</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#pgsql_local_create"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pgsql_local_create" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates pgsql configuration.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>databases</strong> – List of databases.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference internal" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig" title="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">ServiceLocalConfig</span></code></a> instance.</p>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="marks-1">
<h3><a class="toc-backref" href="#toc-entry-15" role="doc-backlink">Marks</a><a class="headerlink" href="#marks-1" title="Permalink to this headline">¶</a></h3>
<section id="pytest-mark-pgsql">
<h4>pytest.mark.pgsql<a class="headerlink" href="#pytest-mark-pgsql" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.pgsql.pytest_plugin.pytest.mark.pgsql">
<code class="descclassname">pytest.mark.</code><code class="descname">pgsql</code><span class="sig-paren">(</span><em>dbname</em>, <em>files=()</em>, <em>directories=()</em>, <em>queries=()</em><span class="sig-paren">)</span><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.pytest.mark.pgsql" title="Permalink to this definition">¶</a></dt>
<dd><p>Use this mark to override specify extra data fixtures in a per-test manner.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dbname</strong> – Database name.</p></li>
<li><p><strong>files</strong> – List of filenames to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of directories to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of queries to apply to the database.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="classes-1">
<h3><a class="toc-backref" href="#toc-entry-16" role="doc-backlink">Classes</a><a class="headerlink" href="#classes-1" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig">
<em class="property">class </em><code class="descclassname">testsuite.databases.pgsql.pytest_plugin.</code><code class="descname">ServiceLocalConfig</code><a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#ServiceLocalConfig"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig" title="Permalink to this definition">¶</a></dt>
<dd><dl class="method">
<dt id="testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig.__getitem__">
<code class="descname">__getitem__</code><span class="sig-paren">(</span><em>dbname: str</em><span class="sig-paren">)</span> &#x2192; testsuite.databases.pgsql.connection.PgConnectionInfo<a class="reference internal" href="../_modules/testsuite/databases/pgsql/pytest_plugin/#ServiceLocalConfig.__getitem__"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.pytest_plugin.ServiceLocalConfig.__getitem__" title="Permalink to this definition">¶</a></dt>
<dd><p>Get
<a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.pgsql.connection.PgConnectionInfo</span></code></a>
instance by database name</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="testsuite.databases.pgsql.connection.PgConnectionInfo">
<em class="property">class </em><code class="descclassname">testsuite.databases.pgsql.connection.</code><code class="descname">PgConnectionInfo</code><a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="Permalink to this definition">¶</a></dt>
<dd><p>PostgreSQL connection parameters</p>
<dl class="method">
<dt id="testsuite.databases.pgsql.connection.PgConnectionInfo.get_dsn">
<code class="descname">get_dsn</code><span class="sig-paren">(</span><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo.get_dsn"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo.get_dsn" title="Permalink to this definition">¶</a></dt>
<dd><p>PostgreSQL connection string in DSN format</p>
</dd></dl>

<dl class="method">
<dt id="testsuite.databases.pgsql.connection.PgConnectionInfo.get_uri">
<code class="descname">get_uri</code><span class="sig-paren">(</span><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo.get_uri"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo.get_uri" title="Permalink to this definition">¶</a></dt>
<dd><p>PostgreSQL connection string in URI format</p>
</dd></dl>

<dl class="method">
<dt id="testsuite.databases.pgsql.connection.PgConnectionInfo.replace">
<code class="descname">replace</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span> &#x2192; testsuite.databases.pgsql.connection.PgConnectionInfo<a class="reference internal" href="../_modules/testsuite/databases/pgsql/connection/#PgConnectionInfo.replace"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.connection.PgConnectionInfo.replace" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a new <a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">PgConnectionInfo</span></code></a> value replacing specified
fields with new values</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="testsuite.databases.pgsql.control.PgDatabaseWrapper">
<em class="property">class </em><code class="descclassname">testsuite.databases.pgsql.control.</code><code class="descname">PgDatabaseWrapper</code><a class="reference internal" href="../_modules/testsuite/databases/pgsql/control/#PgDatabaseWrapper"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper" title="Permalink to this definition">¶</a></dt>
<dd><dl class="attribute">
<dt id="testsuite.databases.pgsql.control.PgDatabaseWrapper.conn">
<code class="descname">conn</code><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.conn" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">psycopg2.extensions.connection</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="attribute">
<dt id="testsuite.databases.pgsql.control.PgDatabaseWrapper.conninfo">
<code class="descname">conninfo</code><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.conninfo" title="Permalink to this definition">¶</a></dt>
<dd><p>returns
<a class="reference internal" href="#testsuite.databases.pgsql.connection.PgConnectionInfo" title="testsuite.databases.pgsql.connection.PgConnectionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">testsuite.databases.pgsql.connection.PgConnectionInfo</span></code></a></p>
</dd></dl>

<dl class="method">
<dt id="testsuite.databases.pgsql.control.PgDatabaseWrapper.cursor">
<code class="descname">cursor</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span> &#x2192; psycopg2.extensions.cursor<a class="reference internal" href="../_modules/testsuite/databases/pgsql/control/#PgDatabaseWrapper.cursor"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.cursor" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">psycopg2.extensions.cursor</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="testsuite.databases.pgsql.control.PgDatabaseWrapper.dict_cursor">
<code class="descname">dict_cursor</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span> &#x2192; psycopg2.extensions.cursor<a class="reference internal" href="../_modules/testsuite/databases/pgsql/control/#PgDatabaseWrapper.dict_cursor"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.pgsql.control.PgDatabaseWrapper.dict_cursor" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns dictionary cursor, see psycopg2.extras.DictCursor</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">psycopg2.extensions.cursor</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="mysql">
<h2><a class="toc-backref" href="#toc-entry-17" role="doc-backlink">MySQL</a><a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h2>
<p>In order to enable mysql support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.databases.mysql.pytest_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure MySQL schemas location.</p>
<p>By default testsuite starts <a class="reference external" href="https://dev.mysql.com/">MySQL</a> service. In this case MySQL installation
is required.</p>
<p>Currently mysql plugin uses synchronous <a class="reference external" href="https://github.com/PyMySQL/PyMySQL">pymysql</a> driver.</p>
<p>MySQL plugin creates database schema once. And then populates database
with data fixtures on each test. It looks for database fixtures by the
following names:</p>
<ul class="simple">
<li><p>file <code class="docutils literal notranslate"><span class="pre">my_DBNAME.sql</span></code></p></li>
<li><p>directory <code class="docutils literal notranslate"><span class="pre">my_DBNAME/</span></code></p></li>
</ul>
<section id="customize-port-1">
<h3><a class="toc-backref" href="#toc-entry-18" role="doc-backlink">Customize port</a><a class="headerlink" href="#customize-port-1" title="Permalink to this headline">¶</a></h3>
<p>Testsuite may start MySQL with custom port, if <code class="docutils literal notranslate"><span class="pre">TESTSUITE_MYSQL_PORT</span></code>
environment variable is specified</p>
</section>
<section id="use-external-instance-1">
<h3><a class="toc-backref" href="#toc-entry-19" role="doc-backlink">Use external instance</a><a class="headerlink" href="#use-external-instance-1" title="Permalink to this headline">¶</a></h3>
<p>You can force it to use your own mysql installation with command-line option
<code class="docutils literal notranslate"><span class="pre">--mysql=mysql://user:password&#64;hostname/</span></code>.</p>
</section>
<section id="example-integration-1">
<h3><a class="toc-backref" href="#toc-entry-20" role="doc-backlink">Example integration</a><a class="headerlink" href="#example-integration-1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">testsuite.databases.mysql</span> <span class="kn">import</span> <span class="n">discover</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mysql_local</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">([</span><span class="n">SCHEMAS_DIR</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="database-access-example-1">
<h3><a class="toc-backref" href="#toc-entry-21" role="doc-backlink">Database access example</a><a class="headerlink" href="#database-access-example-1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_read_from_database</span><span class="p">(</span><span class="n">mysql</span><span class="p">):</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">[</span><span class="s1">&#39;chat_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT username, text FROM messages WHERE id = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],),</span>
    <span class="p">)</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">record</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="functions-1">
<h3><a class="toc-backref" href="#toc-entry-22" role="doc-backlink">Functions</a><a class="headerlink" href="#functions-1" title="Permalink to this headline">¶</a></h3>
<section id="find-schemas-1">
<h4>find_schemas<a class="headerlink" href="#find-schemas-1" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.mysql.discover.find_schemas">
<code class="descclassname">testsuite.databases.mysql.discover.</code><code class="descname">find_schemas</code><span class="sig-paren">(</span><em>schema_dirs: List[pathlib.Path], dbprefix: str = 'testsuite-', extra_schema_args: Optional[Dict[str, Any], None] = None</em><span class="sig-paren">)</span> &#x2192; Dict[str, testsuite.databases.mysql.classes.DatabaseConfig]<a class="reference internal" href="../_modules/testsuite/databases/mysql/discover/#find_schemas"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.mysql.discover.find_schemas" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve database schemas from filesystem.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>schema_dirs</strong> – list of schema pathes</p></li>
<li><p><strong>dbprefix</strong> – database name internal prefix</p></li>
<li><p><strong>extra_schema_args</strong> – for each DB contains list
of tables we don’t have to truncate and flag for explicit creation</p></li>
</ul>
</dd>
</dl>
<dl>
<dt>example:</dt><dd><dl>
<dt>{</dt><dd><dl>
<dt>‘database1’: {</dt><dd><p>‘create’: False,
‘truncate_non_empty’: True,
‘keep_tables’: [</p>
<blockquote>
<div><p>‘table1’, ‘table2’</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>Dictionary where key is dbname and value is
<code class="docutils literal notranslate"><span class="pre">classes.DatabaseConfig</span></code> instance.</p>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="fixtures-2">
<h3><a class="toc-backref" href="#toc-entry-23" role="doc-backlink">Fixtures</a><a class="headerlink" href="#fixtures-2" title="Permalink to this headline">¶</a></h3>
<section id="mysql-2">
<h4>mysql<a class="headerlink" href="#mysql-2" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descclassname">testsuite.databases.mysql.pytest_plugin.</code><code class="descname">mysql</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mysql/pytest_plugin/#mysql"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>MySQL fixture.</p>
<p>Returns dictionary where key is database alias and value is
<code class="xref py py-class docutils literal notranslate"><span class="pre">control.ConnectionWrapper</span></code></p>
</dd></dl>

</section>
<section id="mysql-local">
<h4>mysql_local<a class="headerlink" href="#mysql-local" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descclassname">testsuite.databases.mysql.pytest_plugin.</code><code class="descname">mysql_local</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mysql/pytest_plugin/#mysql_local"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Use to override databases configuration.</p>
</dd></dl>

</section>
<section id="mysql-conninfo">
<h4>mysql_conninfo<a class="headerlink" href="#mysql-conninfo" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descclassname">testsuite.databases.mysql.pytest_plugin.</code><code class="descname">mysql_conninfo</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/mysql/pytest_plugin/#mysql_conninfo"><span class="viewcode-link">[source]</span></a></dt>
<dd></dd></dl>

</section>
</section>
<section id="marks-2">
<h3><a class="toc-backref" href="#toc-entry-24" role="doc-backlink">Marks</a><a class="headerlink" href="#marks-2" title="Permalink to this headline">¶</a></h3>
<section id="pytest-mark-mysql">
<h4>pytest.mark.mysql<a class="headerlink" href="#pytest-mark-mysql" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descname">pytest.mark.mysql(dbname, *, files=(), directories=(), queries=()):</code></dt>
<dd><p>Use this mark to specify extra data fixtures in a per-test manner.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dbname</strong> – Database name.</p></li>
<li><p><strong>files</strong> – List of filenames to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of directories to apply to the database.</p></li>
<li><p><strong>queries</strong> – List of queries to apply to the database.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="classes-2">
<h3><a class="toc-backref" href="#toc-entry-25" role="doc-backlink">Classes</a><a class="headerlink" href="#classes-2" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt>
<em class="property">class </em><code class="descclassname">testsuite.databases.mysql.control.</code><code class="descname">ConnectionWrapper</code><a class="reference internal" href="../_modules/testsuite/databases/mysql/control/#ConnectionWrapper"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>MySQL database connection wrapper.</p>
<dl class="attribute">
<dt>
<code class="descname">conninfo</code></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">classes.ConnectionInfo</span></code> instance.</p>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">cursor</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span> &#x2192; pymysql.cursors.Cursor<a class="reference internal" href="../_modules/testsuite/databases/mysql/control/#ConnectionWrapper.cursor"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Returns cursor instance.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt>
<em class="property">class </em><code class="descclassname">testsuite.databases.mysql.classes.</code><code class="descname">ConnectionInfo</code><a class="reference internal" href="../_modules/testsuite/databases/mysql/classes/#ConnectionInfo"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Mysql connection info class.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>port</strong> – database port</p></li>
<li><p><strong>hostname</strong> – database hostname</p></li>
<li><p><strong>user</strong> – database user</p></li>
<li><p><strong>password</strong> – database password</p></li>
<li><p><strong>dbname</strong> – database name</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt>
<code class="descname">replace</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span> &#x2192; testsuite.databases.mysql.classes.ConnectionInfo<a class="reference internal" href="../_modules/testsuite/databases/mysql/classes/#ConnectionInfo.replace"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Returns new instance with attributes updated.</p>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="redis">
<h2><a class="toc-backref" href="#toc-entry-26" role="doc-backlink">Redis</a><a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h2>
<p>Testsuite provides basic support for redis.</p>
<p>Testsuite may start redis with custom ports, if following environment variables
are specified:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_REDIS_MASTER_PORTS</span></code> - if set, must be two comma separated
integers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_REDIS_SENTINEL_PORT</span></code> - if set, must be integer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TESTSUITE_REDIS_SLAVE_PORTS</span></code> - if set must be three comma separated
integers</p></li>
</ul>
</section>
<section id="clickhouse">
<h2><a class="toc-backref" href="#toc-entry-27" role="doc-backlink">ClickHouse</a><a class="headerlink" href="#clickhouse" title="Permalink to this headline">¶</a></h2>
<p>In order to enable clickhouse support you have to add
<code class="docutils literal notranslate"><span class="pre">testsuite.databases.clickhouse.pytest_plugin</span></code> to <code class="docutils literal notranslate"><span class="pre">pytest_plugins</span></code> list in your
<code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file and configure ClickHouse schemas location.</p>
<p>By default testsuite starts <a class="reference external" href="https://clickhouse.com/">ClickHouse</a> service. In this case ClickHouse installation
is required.</p>
<p>Currently clickhouse plugin uses synchronous <a class="reference external" href="https://github.com/mymarilyn/clickhouse-driver">clickhouse-driver</a> driver.</p>
<p>ClickHouse plugin creates database schema once. And then populates database
with data fixtures on each test. It looks for database fixtures by the
following names:</p>
<ul class="simple">
<li><p>file <code class="docutils literal notranslate"><span class="pre">ch_DBNAME.sql</span></code></p></li>
<li><p>directory <code class="docutils literal notranslate"><span class="pre">ch_DBNAME/</span></code></p></li>
</ul>
<section id="clickhouse-installation">
<h3><a class="toc-backref" href="#toc-entry-28" role="doc-backlink">ClickHouse installation</a><a class="headerlink" href="#clickhouse-installation" title="Permalink to this headline">¶</a></h3>
<p>For debian please run these commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt update <span class="o">&amp;&amp;</span> apt install clickhouse-common-static
</pre></div>
</div>
<p>(<a class="reference external" href="https://clickhouse.com/docs/en/getting-started/install/#packages">https://clickhouse.com/docs/en/getting-started/install/#packages</a>),</p>
<p>For macos follow instructions at <a class="reference external" href="https://clickhouse.com/docs/en/getting-started/install/#from-binaries-non-linux">https://clickhouse.com/docs/en/getting-started/install/#from-binaries-non-linux</a></p>
<p>If you already have clickhouse installed, please symlink it to <code class="docutils literal notranslate"><span class="pre">/usr/bin/clickhouse</span></code></p>
</section>
<section id="customize-ports">
<h3><a class="toc-backref" href="#toc-entry-29" role="doc-backlink">Customize ports</a><a class="headerlink" href="#customize-ports" title="Permalink to this headline">¶</a></h3>
<p>Testsuite may start ClickHouse with custom ports, if
<code class="docutils literal notranslate"><span class="pre">TESTSUITE_CLICKHOUSE_SERVER_TCP_PORT</span></code> or <code class="docutils literal notranslate"><span class="pre">TESTSUITE_CLICKHOUSE_SERVER_HTTP_PORT</span></code>
environment variables are specified.</p>
</section>
<section id="use-external-instance-2">
<h3><a class="toc-backref" href="#toc-entry-30" role="doc-backlink">Use external instance</a><a class="headerlink" href="#use-external-instance-2" title="Permalink to this headline">¶</a></h3>
<p>Usage of external installation is not supported for now.</p>
</section>
<section id="example-integration-2">
<h3><a class="toc-backref" href="#toc-entry-31" role="doc-backlink">Example integration</a><a class="headerlink" href="#example-integration-2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">testsuite.databases.clickhouse</span> <span class="kn">import</span> <span class="n">discover</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clickhouse_local</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">discover</span><span class="o">.</span><span class="n">find_schemas</span><span class="p">([</span><span class="n">SCHEMAS_DIR</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="database-access-example-2">
<h3><a class="toc-backref" href="#toc-entry-32" role="doc-backlink">Database access example</a><a class="headerlink" href="#database-access-example-2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_read_from_database</span><span class="p">(</span><span class="n">clickhouse</span><span class="p">):</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">clickhouse</span><span class="p">[</span><span class="s1">&#39;chat_messages&#39;</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM system.numbers LIMIT 5&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)]</span>
</pre></div>
</div>
</section>
<section id="functions-2">
<h3><a class="toc-backref" href="#toc-entry-33" role="doc-backlink">Functions</a><a class="headerlink" href="#functions-2" title="Permalink to this headline">¶</a></h3>
<section id="find-schemas-2">
<h4>find_schemas<a class="headerlink" href="#find-schemas-2" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="testsuite.databases.clickhouse.discover.find_schemas">
<code class="descclassname">testsuite.databases.clickhouse.discover.</code><code class="descname">find_schemas</code><span class="sig-paren">(</span><em>schema_dirs: List[pathlib.Path], dbprefix: str = 'testsuite-'</em><span class="sig-paren">)</span> &#x2192; Dict[str, testsuite.databases.clickhouse.classes.DatabaseConfig]<a class="reference internal" href="../_modules/testsuite/databases/clickhouse/discover/#find_schemas"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#testsuite.databases.clickhouse.discover.find_schemas" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</section>
</section>
<section id="fixtures-3">
<h3><a class="toc-backref" href="#toc-entry-34" role="doc-backlink">Fixtures</a><a class="headerlink" href="#fixtures-3" title="Permalink to this headline">¶</a></h3>
<section id="clickhouse-2">
<h4>clickhouse<a class="headerlink" href="#clickhouse-2" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descclassname">testsuite.databases.clickhouse.pytest_plugin.</code><code class="descname">clickhouse</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/pytest_plugin/#clickhouse"><span class="viewcode-link">[source]</span></a></dt>
<dd></dd></dl>

</section>
<section id="clickhouse-local">
<h4>clickhouse_local<a class="headerlink" href="#clickhouse-local" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descclassname">testsuite.databases.clickhouse.pytest_plugin.</code><code class="descname">clickhouse_local</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/pytest_plugin/#clickhouse_local"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Use to override databases configuration.</p>
</dd></dl>

</section>
<section id="clickhouse-conn-info">
<h4>clickhouse_conn_info<a class="headerlink" href="#clickhouse-conn-info" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descclassname">testsuite.databases.clickhouse.pytest_plugin.</code><code class="descname">clickhouse_conn_info</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/pytest_plugin/#clickhouse_conn_info"><span class="viewcode-link">[source]</span></a></dt>
<dd></dd></dl>

</section>
</section>
<section id="marks-3">
<h3><a class="toc-backref" href="#toc-entry-35" role="doc-backlink">Marks</a><a class="headerlink" href="#marks-3" title="Permalink to this headline">¶</a></h3>
<section id="pytest-mark-clickhouse">
<h4>pytest.mark.clickhouse<a class="headerlink" href="#pytest-mark-clickhouse" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<code class="descname">pytest.mark.clickhouse(dbname, *, files=(), directories=(), queries=()):</code></dt>
<dd><p>Use this mark to specify extra data fixtures in a per-test manner.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dbname</strong> – Database name.</p></li>
<li><p><strong>files</strong> – List of filenames to apply to the database.</p></li>
<li><p><strong>directories</strong> – List of directories to apply to the database.</p></li>
<li><p><strong>queries</strong> – List of queries to apply to the database.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="classes-3">
<h3><a class="toc-backref" href="#toc-entry-36" role="doc-backlink">Classes</a><a class="headerlink" href="#classes-3" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt>
<em class="property">class </em><code class="descclassname">testsuite.databases.clickhouse.classes.</code><code class="descname">ConnectionInfo</code><a class="reference internal" href="../_modules/testsuite/databases/clickhouse/classes/#ConnectionInfo"><span class="viewcode-link">[source]</span></a></dt>
<dd><p>Clickhouse connection parameters</p>
</dd></dl>

</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../reference/">API reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../staticfiles/">Working with static files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mockserver/">Mockserver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../servicerunner/">Spawning and accessing service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testpoint/">Testpoint</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Database support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../other_plugins/">Other plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utils/">Utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples/README/">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license/">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../">Documentation overview</a><ul>
  <li><a href="../reference/">API reference</a><ul>
      <li>Previous: <a href="../testpoint/" title="previous chapter">Testpoint</a></li>
      <li>Next: <a href="../other_plugins/" title="next chapter">Other plugins</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020-2022, Yandex LLC.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/databases.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>